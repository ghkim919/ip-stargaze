# IP Stargaze - 기능 명세서

> IP 트래픽을 실시간으로 수집하여 Star(별) 그래프로 대역별 시각화하는 웹 애플리케이션

---

## 1. 요청 분석

### 1.1 핵심 문제 정의

서버 관리자/보안 담당자가 서버로 유입되는 IP 트래픽의 대역별 분포를 **직관적으로 파악**할 수 없는 문제를 해결한다. 기존 텍스트 기반 로그 분석 대신, 별(Star) 모양의 방사형 그래프를 통해 어떤 IP 대역에서 트래픽이 집중되는지 한눈에 볼 수 있게 한다.

### 1.2 명시적 요구사항

| # | 요구사항 | 출처 |
|---|---------|------|
| E-01 | 서버로 들어오는 IP를 실시간 캡처/수집 | 사용자 명시 |
| E-02 | IP 대역(/8, /16, /24)별 그룹핑 | 사용자 명시 |
| E-03 | Star 그래프로 실시간 방사형 시각화 | 사용자 명시 |
| E-04 | 가지의 크기/길이가 트래픽 양 반영 | 사용자 명시 |
| E-05 | WebSocket 기반 실시간 업데이트 | 사용자 명시 |
| E-06 | 대역별 색상 구분 | 사용자 명시 |
| E-07 | 클릭 시 상세 정보 표시 | 사용자 명시 |
| E-08 | 시뮬레이션 모드 지원 | 사용자 명시 |
| E-09 | 대시보드 형태 통계 정보 | 사용자 명시 |
| E-10 | 반응형 디자인 | 사용자 명시 |

### 1.3 암묵적 요구사항 (도출)

| # | 요구사항 | 근거 |
|---|---------|------|
| I-01 | IPv4 지원 (IPv6는 추후) | IP 대역 /8, /16, /24 표기는 IPv4 기준 |
| I-02 | 수집 데이터의 시간 범위 설정 (최근 1분/5분/1시간 등) | 실시간 시각화이므로 시간 윈도우 필요 |
| I-03 | 브라우저 호환성 (Chrome, Firefox, Safari, Edge 최신 2버전) | 웹앱이므로 당연히 기대 |
| I-04 | 동시 접속 사용자 지원 | WebSocket 서버이므로 다중 클라이언트 고려 |
| I-05 | 그래프 성능 최적화 (대량 IP 대역 처리) | 실시간 업데이트 시 렌더링 성능 중요 |
| I-06 | 서버 실행 시 권한 관리 (pcap은 root 권한 필요) | 패킷 캡처 기술적 제약 |
| I-07 | 에러/연결 끊김 시 재연결 로직 | WebSocket 안정성 |

### 1.4 전제 조건 (Assumptions)

| # | 전제 | 근거 |
|---|------|------|
| A-01 | 단일 서버의 특정 네트워크 인터페이스를 모니터링한다 | 분산 환경은 명시되지 않음 |
| A-02 | 인바운드 트래픽만 모니터링한다 (아웃바운드 제외) | "서버로 들어오는 IP" |
| A-03 | 인증/권한 관리는 1차 범위에서 제외한다 | 별도 언급 없음 |
| A-04 | 데이터 영속성(DB 저장)은 1차 범위에서 제외한다 | 실시간 모니터링 중심 |
| A-05 | 단일 프로세스로 동작한다 (클러스터링 불필요) | 개인/소규모 서버 모니터링 도구 |

---

## 2. 범위 정의

### 2.1 IN Scope (포함)

- 실시간 IP 패킷 캡처 (pcap 기반) 및 시뮬레이션 모드
- IP 대역별 그룹핑 (/8, /16, /24)
- Star(방사형) 그래프 실시간 시각화
- 대역별 색상 구분 및 인터랙션 (hover, click)
- 대시보드 통계 패널 (총 패킷 수, 고유 IP 수, 상위 대역 등)
- WebSocket 기반 실시간 데이터 스트리밍
- 시간 윈도우 설정 (최근 1분/5분/15분/1시간)
- 반응형 레이아웃

### 2.2 OUT of Scope (제외)

- IPv6 지원
- 아웃바운드 트래픽 모니터링
- 사용자 인증/권한 관리
- 데이터베이스 영속성 저장
- 알림/경보 시스템
- 분산 서버 모니터링
- 패킷 페이로드 분석 (DPI)
- 히스토리 재생 기능

### 2.3 단계별 배포 계획

| 단계 | 범위 | 목표 |
|------|------|------|
| Phase 1 (MVP) | 시뮬레이션 모드 + Star 그래프 + 기본 통계 | 핵심 시각화 검증 |
| Phase 2 | 실제 pcap 캡처 + 시간 윈도우 + 인터랙션 | 실서버 적용 가능 |
| Phase 3 | 대시보드 고도화 + 반응형 + 성능 최적화 | 프로덕션 수준 |

---

## 3. 기능 목록 (우선순위별, MoSCoW)

### Must Have (필수)

| ID | 기능명 | 설명 | Phase |
|----|--------|------|-------|
| F-001 | 시뮬레이션 IP 생성기 | 랜덤 IP 트래픽 데이터를 주기적으로 생성 | 1 |
| F-002 | IP 대역 분류 엔진 | IP 주소를 /8, /16, /24 대역으로 그룹핑 | 1 |
| F-003 | WebSocket 서버 | 클라이언트에 실시간 데이터 스트리밍 | 1 |
| F-004 | Star 그래프 렌더링 | 방사형 별 모양 그래프 Canvas/D3.js 렌더링 | 1 |
| F-005 | 대역별 색상 매핑 | 각 IP 대역에 고유 색상 할당 | 1 |
| F-006 | 실시간 pcap 캡처 | 네트워크 인터페이스에서 실시간 패킷 캡처 | 2 |
| F-007 | 캡처 모드 전환 | 시뮬레이션/실제캡처 모드 전환 | 2 |

### Should Have (권장)

| ID | 기능명 | 설명 | Phase |
|----|--------|------|-------|
| F-008 | 대역 클릭 상세 패널 | 클릭 시 해당 대역의 IP 목록, 트래픽 통계 표시 | 2 |
| F-009 | 시간 윈도우 선택 | 표시할 데이터의 시간 범위 설정 | 2 |
| F-010 | 대시보드 통계 패널 | 총 패킷 수, 고유 IP 수, PPS, 상위 대역 | 2 |
| F-011 | 대역 수준 전환 | /8, /16, /24 중 표시할 대역 수준 선택 | 2 |
| F-012 | Hover 툴팁 | 가지에 마우스 올리면 요약 정보 표시 | 1 |

### Could Have (선택)

| ID | 기능명 | 설명 | Phase |
|----|--------|------|-------|
| F-013 | 반응형 레이아웃 | 다양한 화면 크기 대응 | 3 |
| F-014 | 다크 모드 | 다크/라이트 테마 전환 | 3 |
| F-015 | 그래프 애니메이션 | 가지 성장/축소 트랜지션 애니메이션 | 3 |
| F-016 | 네트워크 인터페이스 선택 | 모니터링할 인터페이스 선택 UI | 3 |
| F-017 | 스냅샷 내보내기 | 현재 그래프 상태를 PNG/SVG로 저장 | 3 |

### Won't Have (이번 범위 제외)

| ID | 기능명 | 사유 |
|----|--------|------|
| F-018 | IPv6 지원 | 1차 범위 과다, 추후 확장 |
| F-019 | 사용자 인증 | 내부 도구 성격, 불필요 |
| F-020 | DB 저장/히스토리 | 실시간 모니터링 중심 |
| F-021 | 알림/경보 시스템 | 보안 도구와 역할 중복 |

---

## 4. 기술 스택 확정

### 4.1 백엔드

| 항목 | 선택 | 사유 |
|------|------|------|
| 런타임 | Node.js (v20 LTS) | 이벤트 기반 I/O, WebSocket 친화적 |
| 프레임워크 | Fastify | Express 대비 성능 우수, 플러그인 생태계 |
| WebSocket | @fastify/websocket (ws 기반) | Fastify 네이티브 통합 |
| 패킷 캡처 | cap (libpcap 바인딩) | Node.js용 pcap 라이브러리 중 유지보수 양호 |
| IP 유틸리티 | ip-address 또는 직접 구현 | CIDR 계산, 대역 분류 |

### 4.2 프론트엔드

| 항목 | 선택 | 사유 |
|------|------|------|
| 기본 | Vanilla HTML/CSS/JS | 프레임워크 의존 최소화, 빠른 프로토타이핑 |
| 시각화 | D3.js v7 | 방사형 그래프 구현에 최적, 데이터 바인딩 강력 |
| 렌더링 | SVG (D3.js 기본) + Canvas fallback | SVG로 인터랙션 용이, 대량 데이터 시 Canvas |
| 스타일 | CSS Custom Properties + 미디어 쿼리 | 다크 모드, 반응형 대응 용이 |

### 4.3 개발 도구

| 항목 | 선택 |
|------|------|
| 패키지 매니저 | npm |
| 린터 | ESLint (flat config) |
| 번들러 | 없음 (ES Modules, 정적 파일 서빙) |
| 테스트 | Vitest (단위 테스트) |

### 4.4 기술 스택 의존성 다이어그램

```
[Browser]
   |
   |-- HTTP GET --> [Fastify Static] --> HTML/CSS/JS + D3.js
   |
   |-- WebSocket --> [Fastify WebSocket] <-- [IP Collector]
                                                  |
                                          [Simulation Mode]
                                                  or
                                          [pcap Capture Mode]
```

---

## 5. 프로젝트 구조

```
ip-stargaze/
├── docs/
│   └── SPEC.md                    # 이 명세서
├── src/
│   ├── server/
│   │   ├── index.js               # 서버 진입점 (Fastify 초기화)
│   │   ├── config.js              # 서버 설정 (포트, 모드, 인터페이스 등)
│   │   ├── capture/
│   │   │   ├── captureManager.js  # 캡처 모드 관리자 (모드 전환)
│   │   │   ├── pcapCapture.js     # 실제 pcap 기반 패킷 캡처
│   │   │   └── simulator.js       # 시뮬레이션 IP 생성기
│   │   ├── analysis/
│   │   │   ├── ipClassifier.js    # IP -> 대역 분류 엔진
│   │   │   └── aggregator.js      # 대역별 통계 집계
│   │   └── ws/
│   │       └── wsHandler.js       # WebSocket 연결 관리 및 브로드캐스트
│   └── client/
│       ├── index.html             # 메인 HTML
│       ├── css/
│       │   └── style.css          # 전체 스타일 (다크 모드 포함)
│       ├── js/
│       │   ├── app.js             # 앱 진입점 (WebSocket 연결, 이벤트 관리)
│       │   ├── starGraph.js       # Star 그래프 D3.js 렌더링 모듈
│       │   ├── detailPanel.js     # 클릭 시 상세 정보 패널
│       │   ├── dashboard.js       # 통계 대시보드 컴포넌트
│       │   └── utils.js           # 색상 매핑, 포맷팅 유틸리티
│       └── assets/
│           └── favicon.svg        # 파비콘
├── test/
│   ├── ipClassifier.test.js       # IP 분류 엔진 테스트
│   ├── aggregator.test.js         # 집계 로직 테스트
│   └── simulator.test.js          # 시뮬레이션 생성기 테스트
├── package.json
├── .gitignore
└── .env.example                   # 환경 변수 예시 (실제 .env는 gitignore)
```

---

## 6. 기능별 상세 명세

---

### 6.1 기능: 시뮬레이션 IP 생성기 (F-001)

#### 개요
- **목적**: 실제 패킷 캡처 없이 개발/테스트를 가능하게 하는 가상 IP 트래픽 생성기
- **사용자**: 개발자, 시연 담당자
- **트리거**: 서버 시작 시 시뮬레이션 모드로 설정된 경우 자동 실행

#### 상세 요구사항

- **FR-001**: 설정 가능한 간격(기본 100ms)으로 랜덤 IP 패킷 이벤트를 생성한다
- **FR-002**: 생성되는 IP 분포는 현실적인 패턴을 반영한다
  - 특정 대역에 트래픽이 집중되는 "핫스팟" 패턴
  - 전체 IPv4 공간에서 균등 분포가 아닌, 가중치 기반 분포
- **FR-003**: 시뮬레이션 속도(초당 이벤트 수)를 런타임에 조절할 수 있다
- **FR-004**: 사전 정의된 시나리오를 제공한다
  - "normal": 일반적인 트래픽 분포
  - "attack": 특정 대역에서 집중 트래픽 (DDoS 시뮬레이션)
  - "scan": 순차적 IP 스캔 패턴
- **FR-005**: 각 생성 이벤트는 다음 데이터를 포함한다
  - 출발지 IP (source IP)
  - 목적지 포트 (destination port)
  - 프로토콜 (TCP/UDP/ICMP)
  - 타임스탬프

#### 사용자 시나리오

**정상 흐름**:
1. 서버가 `MODE=simulation`으로 시작된다
2. Simulator가 초기화되고 "normal" 시나리오로 IP 이벤트 생성을 시작한다
3. 생성된 이벤트가 CaptureManager를 통해 분석 파이프라인으로 전달된다
4. 서버 로그에 "Simulation mode active, generating ~10 events/sec" 메시지가 출력된다

**예외 흐름**:
- 잘못된 시나리오 이름이 주어진 경우: "normal"로 폴백하고 경고 로그 출력
- 속도가 0 이하로 설정된 경우: 최소값 1로 보정

#### 입출력 정의

**입력 (설정)**:
```
{
  scenario: "normal" | "attack" | "scan",
  eventsPerSecond: number (1-1000, 기본값 10),
  hotspotSubnets: string[] (선택, 예: ["192.168.0.0/16", "10.0.0.0/8"])
}
```

**출력 (이벤트)**:
```
{
  sourceIp: "203.0.113.45",
  destPort: 443,
  protocol: "TCP",
  timestamp: 1739635200000,
  bytes: 1420
}
```

#### 수용 기준

- **AC-001**: Given 서버가 시뮬레이션 모드로 시작되었을 때, When 1초가 경과하면, Then 설정된 eventsPerSecond(+-20% 오차)만큼의 이벤트가 생성된다
- **AC-002**: Given "attack" 시나리오가 선택되었을 때, When 이벤트가 100개 생성되면, Then 전체의 70% 이상이 지정된 hotspot 대역에서 발생한다
- **AC-003**: Given 시뮬레이션 중일 때, When 속도를 변경하면, Then 다음 1초 주기부터 새로운 속도가 적용된다

#### 제약사항 및 고려사항
- 메모리 누수 방지: 생성된 이벤트 객체는 파이프라인 전달 후 참조 해제
- setInterval 대신 정밀한 타이밍이 필요한 경우 setTimeout 재귀 또는 worker thread 고려

---

### 6.2 기능: IP 대역 분류 엔진 (F-002)

#### 개요
- **목적**: 개별 IP 주소를 /8, /16, /24 CIDR 대역으로 분류하고 그룹핑
- **사용자**: 시스템 내부 (다른 모듈이 호출)
- **트리거**: IP 이벤트가 수신될 때마다 호출

#### 상세 요구사항

- **FR-006**: IPv4 주소를 입력받아 /8, /16, /24 세 가지 수준의 대역 정보를 반환한다
- **FR-007**: 대역 정보에는 네트워크 주소와 CIDR 표기가 포함된다
  - 예: "192.168.1.100" -> { "/8": "192.0.0.0/8", "/16": "192.168.0.0/16", "/24": "192.168.1.0/24" }
- **FR-008**: 사설 IP 대역(RFC 1918)을 식별하고 라벨링한다
  - 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16
- **FR-009**: 잘 알려진 IP 대역에 대해 설명 라벨을 제공한다
  - 예: "8.8.0.0/16" -> "Google DNS"
  - 주요 클라우드/CDN 대역 (AWS, GCP, Cloudflare 등)
- **FR-010**: 비트 연산 기반으로 O(1) 시간 복잡도로 분류한다

#### 입출력 정의

**입력**:
```
sourceIp: "203.0.113.45"
```

**출력**:
```
{
  ip: "203.0.113.45",
  subnets: {
    "/8":  { network: "203.0.0.0/8",     label: null },
    "/16": { network: "203.0.0.0/16",    label: null },
    "/24": { network: "203.0.113.0/24",  label: "TEST-NET-3 (RFC 5737)" }
  },
  isPrivate: false,
  isReserved: true
}
```

#### 수용 기준

- **AC-004**: Given 유효한 IPv4 주소 "10.0.1.5"가 입력되었을 때, When 분류를 실행하면, Then /8은 "10.0.0.0/8", /16은 "10.0.0.0/16", /24는 "10.0.1.0/24"를 반환하고 isPrivate은 true이다
- **AC-005**: Given 유효하지 않은 IP "999.999.999.999"가 입력되었을 때, When 분류를 실행하면, Then null을 반환하고 에러를 throw하지 않는다
- **AC-006**: Given 1만 개의 IP가 입력되었을 때, When 전체 분류를 실행하면, Then 100ms 이내에 완료된다

---

### 6.3 기능: 대역별 통계 집계기 (Aggregator)

#### 개요
- **목적**: 분류된 IP 이벤트를 대역별로 집계하여 시각화에 필요한 통계 데이터를 생성
- **사용자**: 시스템 내부 (WebSocket 핸들러가 소비)
- **트리거**: IP 이벤트 수신 시 실시간 집계, 주기적으로 클라이언트에 전송

#### 상세 요구사항

- **FR-011**: 슬라이딩 윈도우 방식으로 지정된 시간 범위 내의 데이터만 집계한다
  - 지원 윈도우: 1분, 5분, 15분, 1시간
  - 만료된 이벤트는 자동으로 집계에서 제거된다
- **FR-012**: 각 대역에 대해 다음 통계를 집계한다
  - 패킷 수 (count)
  - 고유 IP 수 (uniqueIps)
  - 바이트 수 (bytes)
  - 초당 패킷 수 (pps - packets per second)
- **FR-013**: 설정 가능한 주기(기본 1초)로 집계 스냅샷을 생성한다
- **FR-014**: 전체 통계 요약(총 패킷, 총 고유 IP, 총 PPS, 상위 5개 대역)을 함께 제공한다

#### 입출력 정의

**출력 (집계 스냅샷, WebSocket으로 전송)**:
```json
{
  "timestamp": 1739635200000,
  "window": "5m",
  "subnetLevel": "/16",
  "summary": {
    "totalPackets": 15234,
    "totalUniqueIps": 892,
    "totalPps": 50.8,
    "topSubnets": [
      { "network": "192.168.0.0/16", "count": 3500, "percentage": 22.9 }
    ]
  },
  "subnets": [
    {
      "network": "192.168.0.0/16",
      "label": "Private (RFC 1918)",
      "count": 3500,
      "uniqueIps": 245,
      "bytes": 4970000,
      "pps": 11.6,
      "isPrivate": true
    },
    {
      "network": "8.8.0.0/16",
      "label": "Google DNS",
      "count": 1200,
      "uniqueIps": 3,
      "bytes": 1704000,
      "pps": 4.0,
      "isPrivate": false
    }
  ]
}
```

#### 수용 기준

- **AC-007**: Given 시간 윈도우가 1분으로 설정되었을 때, When 70초 전에 수신된 이벤트가 있으면, Then 해당 이벤트는 집계에서 제외된다
- **AC-008**: Given 동일 대역의 서로 다른 IP에서 이벤트가 발생했을 때, When 집계를 조회하면, Then uniqueIps가 정확하게 중복 제거된 수를 반영한다
- **AC-009**: Given 집계 주기가 1초일 때, When 서버가 동작 중이면, Then 매초 집계 스냅샷이 WebSocket으로 브로드캐스트된다

#### 제약사항 및 고려사항
- 슬라이딩 윈도우 내 이벤트를 시간순 정렬된 배열로 관리하고, 만료 이벤트 제거 시 앞에서부터 순차 제거 (O(k), k = 만료 이벤트 수)
- uniqueIps 계산에 Set 자료구조 사용
- 1시간 윈도우에서 고 트래픽 시 메모리 사용량 주의: 이벤트당 약 100 bytes 가정, 1000 PPS 기준 약 360MB -> 필요 시 샘플링 적용

---

### 6.4 기능: WebSocket 서버 (F-003)

#### 개요
- **목적**: 서버의 실시간 집계 데이터를 브라우저 클라이언트에 전달
- **사용자**: 브라우저 클라이언트 (자동 연결)
- **트리거**: 클라이언트 접속 시 연결 수립, Aggregator의 스냅샷 생성 시 데이터 전송

#### 상세 요구사항

- **FR-015**: 클라이언트 연결 시 현재 상태의 초기 스냅샷을 즉시 전송한다
- **FR-016**: 주기적(1초)으로 집계 스냅샷을 연결된 모든 클라이언트에 브로드캐스트한다
- **FR-017**: 클라이언트로부터 설정 변경 메시지를 수신한다
  - 시간 윈도우 변경: `{ "type": "setWindow", "value": "5m" }`
  - 대역 수준 변경: `{ "type": "setSubnetLevel", "value": "/16" }`
  - 시뮬레이션 시나리오 변경: `{ "type": "setScenario", "value": "attack" }`
- **FR-018**: 연결 수와 상태를 추적한다 (디버깅/모니터링용)
- **FR-019**: 비정상 연결 해제 시 리소스를 정리한다

#### 메시지 프로토콜

**서버 -> 클라이언트**:
```json
{ "type": "snapshot", "data": { ... 집계 스냅샷 ... } }
{ "type": "config",   "data": { "mode": "simulation", "window": "5m", "subnetLevel": "/16" } }
{ "type": "error",    "data": { "message": "Invalid window value" } }
```

**클라이언트 -> 서버**:
```json
{ "type": "setWindow",      "value": "1m" | "5m" | "15m" | "1h" }
{ "type": "setSubnetLevel", "value": "/8" | "/16" | "/24" }
{ "type": "setScenario",    "value": "normal" | "attack" | "scan" }
```

#### 수용 기준

- **AC-010**: Given 클라이언트가 WebSocket에 연결되었을 때, When 연결이 수립되면, Then 1초 이내에 초기 스냅샷과 현재 설정을 수신한다
- **AC-011**: Given 5개의 클라이언트가 연결되었을 때, When 스냅샷이 생성되면, Then 5개 클라이언트 모두 동일한 데이터를 수신한다
- **AC-012**: Given 클라이언트가 setWindow 메시지를 전송했을 때, When 유효한 값이면, Then 해당 클라이언트에 대한 응답이 새로운 윈도우 설정을 반영한다

#### 제약사항
- 동시 연결 클라이언트 수: 최대 50 (개인/소규모 도구 기준)
- 메시지 크기 제한: 1MB (대역 데이터가 과도하게 큰 경우 상위 N개만 전송)

---

### 6.5 기능: Star 그래프 렌더링 (F-004)

#### 개요
- **목적**: IP 대역별 트래픽 분포를 별(Star) 모양 방사형 그래프로 시각화
- **사용자**: 모니터링 담당자 (브라우저에서 확인)
- **트리거**: WebSocket으로 새 스냅샷 수신 시 매 1초 업데이트

#### 상세 요구사항

- **FR-020**: 화면 중앙에 원형 중심점(Hub)을 배치한다
  - 중심점에는 서버 아이콘 또는 "Server" 텍스트를 표시한다
  - 중심점 크기는 총 트래픽 양에 비례하여 변한다 (최소/최대 크기 제한)
- **FR-021**: 중심점에서 각 IP 대역이 방사형으로 뻗어나가는 "가지(Ray)"를 그린다
  - 각 가지는 대역 하나를 나타낸다
  - 가지의 길이: 해당 대역의 패킷 수에 비례 (로그 스케일 적용)
  - 가지의 두께: 해당 대역의 고유 IP 수에 비례
  - 가지의 끝에 대역 이름 라벨을 표시한다
- **FR-022**: 가지는 360도 균등 배분으로 배치한다
  - 대역 수가 변해도 자동으로 각도를 재배분한다
  - 최대 표시 가지 수: 30개 (초과 시 상위 30개만 표시, 나머지는 "Others"로 병합)
- **FR-023**: 각 가지에 고유 색상을 할당한다
  - 사설 IP 대역: 파란 계열
  - 잘 알려진 서비스: 해당 브랜드 색상 또는 녹색 계열
  - 기타: HSL 색공간에서 균등 분배
  - 이전 프레임과 색상 일관성 유지 (동일 대역은 항상 같은 색)
- **FR-024**: 실시간 업데이트 시 부드러운 트랜지션 애니메이션을 적용한다
  - 가지 길이/두께 변화: 300ms ease-out 트랜지션
  - 새 가지 등장: fade-in + 길이 성장 애니메이션
  - 가지 소멸: fade-out 애니메이션
- **FR-025**: 가지 끝에 "반짝임(twinkle)" 효과를 적용한다
  - 최근 1초 이내에 새 패킷이 도착한 가지는 끝부분이 밝게 반짝인다
  - 별 모양 시각적 테마 강화

#### 시각적 레이아웃

```
                    203.0.0.0/8
                        |
                        |  (길이 = 트래픽 양)
           172.16.0.0/8 |
              \         |         / 8.8.0.0/8
               \        |        /
                \       |       /
                 [  SERVER  ]  --- 10.0.0.0/8
                /       |       \
               /        |        \
              /         |         \ 1.1.0.0/16
           44.0.0.0/8   |
                        |
                    192.168.0.0/16
```

#### 사용자 시나리오

**정상 흐름**:
1. 페이지 로드 시 빈 중심점(Hub)이 표시된다
2. WebSocket 연결이 수립되고 초기 스냅샷을 수신한다
3. 스냅샷 데이터 기반으로 가지들이 성장하며 별 형태가 완성된다
4. 매초 새 스냅샷 수신 시 가지 길이/두께가 부드럽게 업데이트된다
5. 활성 트래픽이 있는 가지 끝이 반짝인다

**예외 흐름**:
- WebSocket 연결 끊김: 그래프가 마지막 상태로 유지되며, 연결 상태 인디케이터가 "Disconnected" 표시. 3초 후 자동 재연결 시도 (최대 5회, 이후 수동 재연결 버튼)
- 대역 수가 0인 경우: 중심점만 표시되고 "Waiting for traffic..." 메시지
- 대역 수가 30개 초과: 상위 30개만 표시, "Others" 병합 가지 추가

#### 수용 기준

- **AC-013**: Given 5개 대역의 스냅샷이 수신되었을 때, When 그래프가 렌더링되면, Then 중심점에서 5개의 가지가 72도 간격으로 방사형 배치된다
- **AC-014**: Given "192.168.0.0/16" 대역의 패킷 수가 1000이고 "10.0.0.0/8"이 500일 때, When 그래프가 렌더링되면, Then 전자의 가지가 후자보다 길다
- **AC-015**: Given 이전 프레임에서 "8.8.0.0/16"이 녹색이었을 때, When 새 스냅샷이 수신되어도, Then "8.8.0.0/16"은 동일한 녹색을 유지한다
- **AC-016**: Given 새 스냅샷으로 가지 길이가 변경될 때, When 업데이트가 적용되면, Then 300ms 동안 부드러운 트랜지션으로 변화한다
- **AC-017**: Given 그래프가 표시된 상태에서, When 브라우저 창 크기를 변경하면, Then 그래프가 새로운 크기에 맞게 재배치된다

#### 제약사항 및 고려사항
- **성능**: 30개 가지 + 트랜지션 애니메이션에서 60fps 유지
- **스케일링**: 로그 스케일 적용하여 트래픽 양 극단값 차이 완화
  - `length = MIN_LENGTH + (MAX_LENGTH - MIN_LENGTH) * (Math.log(count + 1) / Math.log(maxCount + 1))`
- **색상 일관성**: 대역 이름을 해시하여 HSL hue 결정, 캐시로 유지

---

### 6.6 기능: 대역 클릭 상세 패널 (F-008)

#### 개요
- **목적**: 특정 대역 가지를 클릭했을 때 해당 대역의 상세 정보를 표시
- **사용자**: 모니터링 담당자
- **트리거**: Star 그래프의 가지 클릭

#### 상세 요구사항

- **FR-026**: 가지 클릭 시 화면 우측에 슬라이드 패널이 열린다
- **FR-027**: 패널에 다음 정보를 표시한다
  - 대역 이름 및 CIDR 표기
  - 라벨 (사설 IP, Google DNS 등)
  - 총 패킷 수 / 고유 IP 수 / PPS / 바이트
  - 상위 10개 개별 IP 목록 (패킷 수 기준)
  - 시간별 트래픽 미니 차트 (최근 윈도우 내)
- **FR-028**: 패널은 실시간으로 업데이트된다 (열려 있는 동안)
- **FR-029**: 패널 외부 클릭 또는 X 버튼으로 닫을 수 있다
- **FR-030**: 다른 가지를 클릭하면 패널 내용이 전환된다

#### 수용 기준

- **AC-018**: Given Star 그래프가 렌더링된 상태에서, When "192.168.0.0/16" 가지를 클릭하면, Then 우측에 해당 대역의 상세 패널이 300ms 슬라이드 애니메이션으로 열린다
- **AC-019**: Given 상세 패널이 열려 있을 때, When 새 스냅샷이 수신되면, Then 패널 내 수치가 실시간으로 갱신된다
- **AC-020**: Given 상세 패널이 열려 있을 때, When 다른 가지를 클릭하면, Then 패널 내용이 새 대역 정보로 전환된다

---

### 6.7 기능: 대시보드 통계 패널 (F-010)

#### 개요
- **목적**: 전체 트래픽에 대한 요약 통계를 한눈에 제공
- **사용자**: 모니터링 담당자
- **트리거**: 페이지 로드 시 표시, 실시간 업데이트

#### 상세 요구사항

- **FR-031**: Star 그래프 상단 또는 좌측에 통계 카드를 배치한다
- **FR-032**: 표시할 통계 항목:
  - 총 패킷 수 (숫자 카운터 애니메이션)
  - 총 고유 IP 수
  - 현재 PPS (Packets Per Second)
  - 활성 대역 수
  - 상위 3개 대역 (이름 + 비율)
- **FR-033**: 각 수치는 실시간 업데이트 시 카운팅 애니메이션 적용
- **FR-034**: 연결 상태 인디케이터를 표시한다
  - 초록 점: Connected
  - 노란 점: Reconnecting
  - 빨간 점: Disconnected

#### 입출력 정의

**입력**: WebSocket 스냅샷의 `summary` 필드

**출력**: 통계 카드 UI

```
+--------------------------------------------------+
| [*] Connected | Mode: Simulation | Window: 5m    |
+--------------------------------------------------+
| Total Packets | Unique IPs | PPS    | Subnets    |
|    15,234     |    892     | 50.8/s |    23      |
+--------------------------------------------------+
| Top: 192.168.0.0/16 (22.9%) | 8.8.0.0/16 (7.8%) |
+--------------------------------------------------+
```

#### 수용 기준

- **AC-021**: Given 페이지가 로드되고 WebSocket이 연결되었을 때, When 첫 스냅샷이 수신되면, Then 모든 통계 카드에 값이 표시된다
- **AC-022**: Given 통계가 표시된 상태에서, When WebSocket 연결이 끊기면, Then 연결 상태가 빨간 점 + "Disconnected"로 변경된다
- **AC-023**: Given 패킷 수가 15,234에서 15,300으로 변경될 때, When 새 스냅샷이 적용되면, Then 카운팅 애니메이션으로 수치가 부드럽게 증가한다

---

### 6.8 기능: 실시간 pcap 캡처 (F-006)

#### 개요
- **목적**: 실제 네트워크 인터페이스에서 패킷을 캡처하여 실시간 모니터링
- **사용자**: 서버 관리자
- **트리거**: 서버 시작 시 캡처 모드로 설정된 경우

#### 상세 요구사항

- **FR-035**: 지정된 네트워크 인터페이스에서 인바운드 IP 패킷을 캡처한다
- **FR-036**: BPF(Berkeley Packet Filter) 필터를 적용한다
  - 기본 필터: `ip and inbound` (인바운드 IP 패킷만)
  - 사용자 정의 필터 지원 (설정 파일)
- **FR-037**: 캡처된 패킷에서 다음 정보를 추출한다
  - 출발지 IP
  - 목적지 포트
  - 프로토콜 (TCP/UDP/ICMP)
  - 패킷 크기 (bytes)
  - 타임스탬프
- **FR-038**: 사용 가능한 네트워크 인터페이스 목록을 제공한다
- **FR-039**: 캡처 시작/중지를 제어할 수 있다

#### 수용 기준

- **AC-024**: Given 캡처 모드로 서버가 시작되었을 때, When 외부에서 해당 서버로 패킷이 도착하면, Then 출발지 IP가 캡처되어 분류 엔진으로 전달된다
- **AC-025**: Given root/sudo 권한 없이 서버를 시작했을 때, When pcap 초기화가 실패하면, Then 명확한 에러 메시지("Root/sudo 권한이 필요합니다")를 출력하고 시뮬레이션 모드로 폴백할지 묻는다
- **AC-026**: Given 캡처 중일 때, When 1000 PPS의 트래픽이 유입되면, Then 패킷 드롭 없이 처리한다 (또는 드롭률 1% 미만)

#### 제약사항
- libpcap이 시스템에 설치되어 있어야 한다
- macOS: `sudo` 필요, Linux: `CAP_NET_RAW` capability 또는 `sudo`
- 고 트래픽 환경에서 CPU 사용량 모니터링 필요

---

### 6.9 기능: 설정 컨트롤 UI (F-007, F-009, F-011)

#### 개요
- **목적**: 사용자가 시각화 설정을 실시간으로 변경할 수 있는 컨트롤 영역
- **사용자**: 모니터링 담당자
- **트리거**: 사용자 조작

#### 상세 요구사항

- **FR-040**: 시간 윈도우 선택 드롭다운
  - 옵션: 1분, 5분, 15분, 1시간
  - 기본값: 5분
  - 변경 시 WebSocket으로 서버에 전달, 즉시 그래프 반영
- **FR-041**: 대역 수준 선택 버튼 그룹
  - 옵션: /8, /16, /24
  - 기본값: /16
  - 토글 버튼 형태, 활성 상태 시각적 구분
- **FR-042**: 시뮬레이션 모드일 때 시나리오 선택 드롭다운
  - 옵션: Normal, Attack, Scan
  - 실제 캡처 모드에서는 비활성화(disabled)
- **FR-043**: 캡처 모드 표시 (읽기 전용 뱃지)
  - "SIMULATION" (주황색 뱃지) 또는 "LIVE CAPTURE" (녹색 뱃지)
- **FR-044**: 컨트롤 영역은 Star 그래프 상단에 고정 배치

#### 수용 기준

- **AC-027**: Given /16 대역으로 표시 중일 때, When /24 버튼을 클릭하면, Then 그래프가 /24 수준 대역으로 재구성되고 가지 수가 증가한다
- **AC-028**: Given 시뮬레이션 모드에서 "Normal" 시나리오 중일 때, When "Attack"으로 변경하면, Then 그래프에서 특정 대역의 가지가 급격히 성장한다
- **AC-029**: Given 시간 윈도우를 1분에서 1시간으로 변경했을 때, When 다음 스냅샷이 수신되면, Then 더 많은 누적 데이터가 반영된 그래프가 표시된다

---

### 6.10 화면 레이아웃 명세

#### 전체 레이아웃

```
+================================================================+
| [IP Stargaze]    [SIMULATION]  Window:[5m v]  Level:[/8|/16|/24]|  <- 상단 바
|                  [Scenario: Normal v]         [* Connected]     |
+================================================================+
|                                                |                |
|   +------------------------------------------+ | +------------+|
|   | Total: 15,234 | IPs: 892 | PPS: 50.8/s  | | |  Detail    ||
|   +------------------------------------------+ | |  Panel     ||
|   |                                          | | |            ||
|   |                                          | | | Network:   ||
|   |              [STAR GRAPH]                | | | 192.168.   ||
|   |                                          | | | 0.0/16     ||
|   |           중심에서 방사형으로             | | |            ||
|   |            가지가 뻗어나감                | | | Packets:   ||
|   |                                          | | | 3,500      ||
|   |                                          | | |            ||
|   |                                          | | | Top IPs:   ||
|   |                                          | | | 192.168.   ||
|   |                                          | | | 1.100 (45) ||
|   +------------------------------------------+ | +------------+|
|                                                |                |
+================================================================+
```

#### 반응형 브레이크포인트

| 화면 크기 | 레이아웃 변경 |
|----------|-------------|
| >= 1200px | 기본 레이아웃 (그래프 + 우측 패널) |
| 768-1199px | 패널이 오버레이로 전환 |
| < 768px | 통계 카드가 세로 배치, 패널은 하단 시트 |

---

## 7. 구현 로드맵

### Phase 1: MVP (예상 기간: 3-4일)

| 순서 | 작업 | 의존성 | 산출물 |
|------|------|--------|--------|
| 1-1 | 프로젝트 초기화 (package.json, 디렉토리 구조, .gitignore) | 없음 | 프로젝트 스캐폴딩 |
| 1-2 | Fastify 서버 + 정적 파일 서빙 설정 | 1-1 | 서버 기본 동작 |
| 1-3 | 시뮬레이션 IP 생성기 (F-001) | 1-1 | simulator.js |
| 1-4 | IP 대역 분류 엔진 (F-002) | 1-1 | ipClassifier.js |
| 1-5 | 집계 엔진 (Aggregator) | 1-4 | aggregator.js |
| 1-6 | WebSocket 서버 (F-003) | 1-2, 1-5 | wsHandler.js |
| 1-7 | 클라이언트 HTML/CSS 기본 구조 | 1-2 | index.html, style.css |
| 1-8 | Star 그래프 기본 렌더링 (F-004) | 1-7 | starGraph.js |
| 1-9 | WebSocket 클라이언트 + 그래프 연동 | 1-6, 1-8 | app.js |
| 1-10 | 대역별 색상 매핑 (F-005) | 1-8 | utils.js |
| 1-11 | Hover 툴팁 (F-012) | 1-8 | starGraph.js 확장 |
| 1-12 | 통합 테스트 + 버그 수정 | 1-9 | 동작하는 MVP |

### Phase 2: 핵심 기능 완성 (예상 기간: 3-4일)

| 순서 | 작업 | 의존성 | 산출물 |
|------|------|--------|--------|
| 2-1 | pcap 캡처 모듈 (F-006) | Phase 1 | pcapCapture.js |
| 2-2 | 캡처 모드 전환 (F-007) | 2-1 | captureManager.js |
| 2-3 | 클릭 상세 패널 (F-008) | Phase 1 | detailPanel.js |
| 2-4 | 시간 윈도우 설정 UI (F-009) | Phase 1 | 컨트롤 UI |
| 2-5 | 대시보드 통계 패널 (F-010) | Phase 1 | dashboard.js |
| 2-6 | 대역 수준 전환 UI (F-011) | Phase 1 | 컨트롤 UI 확장 |
| 2-7 | WebSocket 재연결 로직 | Phase 1 | app.js 확장 |
| 2-8 | 통합 테스트 + 버그 수정 | 2-1~2-7 | 완성된 기능 |

### Phase 3: 고도화 (예상 기간: 2-3일)

| 순서 | 작업 | 의존성 | 산출물 |
|------|------|--------|--------|
| 3-1 | 반응형 레이아웃 (F-013) | Phase 2 | CSS 미디어 쿼리 |
| 3-2 | 다크 모드 (F-014) | Phase 2 | CSS 변수 테마 |
| 3-3 | 그래프 애니메이션 고도화 (F-015) | Phase 2 | 트랜지션 개선 |
| 3-4 | 네트워크 인터페이스 선택 (F-016) | Phase 2 | UI + API |
| 3-5 | 스냅샷 내보내기 (F-017) | Phase 2 | 내보내기 기능 |
| 3-6 | 성능 최적화 + 최종 테스트 | 3-1~3-5 | 프로덕션 레디 |

---

## 8. 리스크 분석 및 완화 전략

| # | 리스크 | 영향도 | 발생 확률 | 완화 전략 |
|---|--------|--------|----------|----------|
| R-01 | pcap 라이브러리의 Node.js 호환성 문제 | 높음 | 중간 | 시뮬레이션 모드를 먼저 구현하여 핵심 기능 검증. pcap 대안으로 raw-socket 또는 tshark 파이프 고려 |
| R-02 | 고 트래픽 시 브라우저 렌더링 성능 저하 | 높음 | 중간 | 대역 수 상한(30개) 설정, 로그 스케일 적용, 필요 시 Canvas 렌더링으로 전환 |
| R-03 | 1시간 윈도우에서 메모리 초과 | 중간 | 낮음 | 이벤트 데이터를 시간 버킷으로 요약 저장, 개별 이벤트 대신 집계 데이터만 유지 |
| R-04 | WebSocket 연결 불안정 | 중간 | 낮음 | 지수 백오프 재연결, 마지막 상태 로컬 캐시 |
| R-05 | 다수 클라이언트 동시 접속 시 서버 부하 | 낮음 | 낮음 | 브로드캐스트 최적화, 클라이언트 수 제한 |

---

## 9. 비기능 요구사항

| 항목 | 요구사항 |
|------|---------|
| 성능 | Star 그래프 렌더링 60fps 유지 (30개 가지 기준) |
| 성능 | 서버-클라이언트 데이터 전송 지연 < 100ms |
| 성능 | IP 분류 엔진 처리량 >= 10,000 IP/초 |
| 가용성 | WebSocket 연결 끊김 시 5초 이내 자동 재연결 |
| 사용성 | 페이지 로드 후 3초 이내 첫 그래프 표시 |
| 호환성 | Chrome 120+, Firefox 120+, Safari 17+, Edge 120+ |
| 보안 | 패킷 페이로드를 수집하거나 저장하지 않음 (IP 헤더만 처리) |
| 유지보수성 | 모듈별 분리, JSDoc 주석, 단위 테스트 커버리지 > 80% (핵심 모듈) |

---

## 10. 용어 사전

| 용어 | 설명 |
|------|------|
| Star Graph | 중심점에서 방사형으로 뻗어나가는 별 모양 그래프. 각 가지(Ray)가 데이터 카테고리를 나타냄 |
| Ray / 가지 | Star Graph에서 중심에서 외곽으로 뻗는 하나의 선. 각 IP 대역을 나타냄 |
| Hub / 중심점 | Star Graph의 중심 원. 모니터링 대상 서버를 나타냄 |
| CIDR | Classless Inter-Domain Routing. IP 주소 대역을 표기하는 방법 (예: 192.168.0.0/16) |
| Subnet Level | IP 대역의 분류 수준. /8 (가장 넓음) ~ /24 (가장 좁음) |
| PPS | Packets Per Second. 초당 패킷 수 |
| Sliding Window | 현재 시점에서 과거 N분/시간까지의 데이터만 유지하는 시간 윈도우 |
| pcap | Packet Capture. 네트워크 인터페이스의 패킷을 캡처하는 라이브러리/기술 |
| BPF | Berkeley Packet Filter. 패킷 캡처 시 필터링 조건을 지정하는 문법 |
